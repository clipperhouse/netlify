<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>WebClient, Fiddler and SSL - clipperhouse</title>
  
  <meta name="description" content="I am developing a credit card authorization library which uses the WebClient class. In addition, I am using the excellent Fiddler to watch the requests and responses.
As you might expect, the credit card web service is HTTPS. Fiddler is acting as a proxy server on my dev machine.
Not surprisingly, WebClient throws an exception: ‚ÄúThe underlying connection was closed: Could not establish secure channel for SSL/TLS‚Äù. As well it should‚Ää‚Äî‚Ääthe SSL certificate in this case is not the one supplied by credit card authorizer.">
  <meta name="author" content="">
  
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700,700i" rel="stylesheet">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/favicon.ico">
  
  <meta name="generator" content="Hugo 0.40.3">
  
  <link rel="alternate" type="application/atom+xml" href="/index.xml" title="clipperhouse">
</head>
<body class="single">
  <header class="header">
    
    <p class="title"><a href="/"><span>üç±</span>clipperhouse</a></p>
    
    <button class="menu-toggle" type="button"></button>
    <nav class="menu">
      <ul>
        
        
      </ul>
    </nav>
  </header>
  <main class="main">

<article class="post post-view">
  <header class="post-header">
    <h1 class="post-title">WebClient, Fiddler and SSL</h1>
    <p class="post-meta">2009.5.1</p>
  </header>
  <div class="post-content"><p>I am developing a credit card authorization library which uses the <a href="http://msdn.microsoft.com/en-us/library/system.net.webclient.aspx">WebClient</a> class. In addition, I am using the excellent <a href="http://www.fiddler2.com">Fiddler</a> to watch the requests and responses.</p>

<p>As you might expect, the credit card web service is HTTPS. Fiddler is acting as a proxy server on my dev machine.</p>

<p>Not surprisingly, WebClient throws an exception: ‚ÄúThe underlying connection was closed: Could not establish secure channel for SSL/TLS‚Äù. As well it should‚Ää‚Äî‚Ääthe SSL certificate in this case is not the one supplied by credit card authorizer. Fiddler is intercepting the request and issuing its own dummy certificate, as it must.</p>

<p>So we‚Äôve got a man-in-the-middle, and WebClient doesn‚Äôt like it. What to do?</p>

<p>Turns out there is a way of telling System.Net to allow invalid certificates to pass. Here‚Äôs the code.</p>

<p>[code:c#]using System.Net;<br />
using System.Net.Security;<br />
using System.Security.Cryptography.X509Certificates;<br />
using System.Web;</p>

<p>public static class Network<br />
{<br />
 public static void AllowInvalidCertificate()<br />
 {<br />
 if (HttpContext.Current.Request.Url.Host == ‚Äúlocalhost‚Äù)<br />
 {<br />
 ServicePointManager.ServerCertificateValidationCallback += new RemoteCertificateValidationCallback(allowCert);<br />
 }<br />
 }</p>

<p>private static bool allowCert(object sender, X509Certificate cert, X509Chain chain, SslPolicyErrors error)<br />
 {<br />
 return true;<br />
 }<br />
}<br />
[/code]</p>

<p>I implemented it as a static class so when I need it in my code I just call Network.AllowInvalidCertificate(). Now my WebClient requests work without throwing an Exception, and Fiddler is able to show me those requests so I can debug.</p>

<p>Do I need to tell you that this is a security risk, so be careful? We‚Äôre disabling one of the fundamental purposes of SSL.</p>

<p>In my case, you‚Äôll notice I check for localhost first, to reduce the risk that this gets called on a production site. You‚Äôll want to put your own precautions in there as well.</p>

<p>Sources:</p>
</div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>
</main>
<footer class="footer">
  <span>&copy; 2017-2018 clipperhouse üéâ</span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" target="_blank">Hugo‚ù§Ô∏èÔ∏è</a></span>
  <span>&middot;</span>
  <span>Designed by <a href="http://21beats.com/" target="_blank">Ô∏è21beats‚ö°Ô∏è</a></span>
</footer>
<script src="https://cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js" data-no-instant></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  menuToggle();
  InstantClick.on('change', function() {
    var blocks = document.querySelectorAll('pre code');
    for (var i = 0; i < blocks.length; i++) {
      hljs.highlightBlock(blocks[i]);
    }
    menuToggle();
  });
  function menuToggle() {
    var $toggle = document.querySelector('.menu-toggle');
    if (!$toggle.offsetParent) {
      return;
    }
    var $body = document.querySelector('body');
    $toggle.addEventListener('click', function() {
      $body.classList.toggle('noscroll');
    }, false);
  }
</script>
</body>
</html>

